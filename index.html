<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Operator DAG</title>
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    #cy {
      width: 100%;
      height: 100%;
      background: #111; /* 加个背景色方便肉眼判断区域是否渲染 */
    }
    #status {
      position: fixed;
      z-index: 9999;
      top: 4px;
      left: 4px;
      padding: 4px 8px;
      background: rgba(255,255,255,0.8);
      font-size: 12px;
      color: #000;
      border-radius: 4px;
    }
  </style>
  <!-- Cytoscape.js CDN -->
  <script src="https://unpkg.com/cytoscape@3/dist/cytoscape.min.js"></script>
</head>
<body>
<div id="status">Loading...</div>
<div id="cy"></div>

<script>
  // 简单检查：Cytoscape 是否加载成功
  if (typeof cytoscape === 'undefined') {
    document.getElementById('status').innerText = 'ERROR: cytoscape is not loaded';
  } else {
    document.getElementById('status').innerText = 'Cytoscape loaded, fetching graph.json...';
  }

  // 加载 graph.json
  fetch('graph.json')
    .then(function(resp) {
      if (!resp.ok) {
        throw new Error('HTTP ' + resp.status);
      }
      return resp.json();
    })
    .then(function(data) {
      var status = document.getElementById('status');
      status.innerText = 'graph.json loaded: ' +
        data.nodes.length + ' nodes, ' +
        data.edges.length + ' edges';

      console.log('graph.json data:', data);

      var elements = [];

      // 节点
      data.nodes.forEach(function(n) {
        elements.push({
          data: {
            id: n.id,
            label: n.label,
            shape: JSON.stringify(n.shape || ''),
            dtype: n.dtype || '',
            op: n.op || ''
          }
        });
      });

      // 边
      data.edges.forEach(function(e) {
        elements.push({
          data: {
            id: e.from + '->' + e.to,
            source: e.from,
            target: e.to
          }
        });
      });

      var cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        style: [
          {
            selector: 'node',
            style: {
              'label': 'data(label)',
              'text-wrap': 'wrap',
              'text-max-width': 160,
              'font-size': 10,
              'background-color': '#8bc34a',
              'border-width': 1,
              'border-color': '#333',
              'color': '#000'
            }
          },
          {
            selector: 'edge',
            style: {
              'width': 1.5,
              'curve-style': 'bezier',
              'target-arrow-shape': 'triangle',
              'target-arrow-color': '#999',
              'line-color': '#999'
            }
          }
        ],
        layout: {
          name: 'breadthfirst',   // 拓扑布局
          directed: true,
          padding: 30
        }
      });

      // 点击节点时展示详细信息
      cy.on('tap', 'node', function (evt) {
        var d = evt.target.data();
        alert(
          'id: '   + d.id   + '\n' +
          'op: '   + d.op   + '\n' +
          'label: ' + d.label + '\n' +
          'shape: ' + d.shape + '\n' +
          'dtype: ' + d.dtype
        );
      });
    })
    .catch(function(err) {
      console.error('Error loading graph.json or rendering graph:', err);
      document.getElementById('status').innerText =
        'ERROR: ' + err.toString();
    });
</script>
</body>
</html>
